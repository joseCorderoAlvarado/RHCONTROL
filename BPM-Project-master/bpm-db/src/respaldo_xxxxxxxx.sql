CREATE OR REPLACE VIEW `APC_INFORMATION_LOAN_WEEK_VIEW`  AS 
select `l`.`id` AS `id`,`u`.`id` AS `id_user`,`r`.`id_office` AS `id_office`,`l`.`created_on` AS `fecha`,`lt`.`payment` AS `apoyos`,`lt`.`payment_total` AS `apoyos_total`,`lt`.`opening_fee` AS `comision_apertura`,concat(`endor`.`first_name`,' ',if((`endor`.`second_name` is null),'',concat(`endor`.`second_name`,' ')),`endor`.`last_name`,' ',`endor`.`middle_name`) AS `aval`,concat(`cus`.`first_name`,' ',if((`cus`.`second_name` is null),'',concat(`cus`.`second_name`,' ')),`cus`.`last_name`,' ',`cus`.`middle_name`) AS `customer`,`l`.`amount_to_pay` AS `documento_por`,`lt`.`payment_daily` AS `abono_diario`,`l`.`amount_paid` AS `amount_paid`,(`l`.`amount_to_pay` - `l`.`amount_paid`) AS `saldo_insoluto`,`r`.`route_name` AS `route_name`,concat(`hr`.`first_name`,' ',if((`hr`.`second_name` is null),'',concat(`hr`.`second_name`,' ')),`hr`.`last_name`,' ',`hr`.`middle_name`) AS `asesor`,(select count(`lfn`.`id`) from `APC_LOAN_FEE_NOTIFICATION` `lfn` where (`lfn`.`id_loan` = `l`.`id`)) AS `num_fee`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'monday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_monday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'monday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_monday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'tuesday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_tuesday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'tuesday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_tuesday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'wednesday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_wednesday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'wednesday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_wednesday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'thursday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_thursday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'thursday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_thursday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'friday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_friday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'friday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_friday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'saturday') and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER')))) AS `payment_saturday`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldLunes`.`created_on` as date))) = 'saturday') and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_saturday`,((`lt`.`payment_daily` * (select if((count(distinct cast(`ldFaltante`.`created_on` as date)) > 5),5,count(distinct cast(`ldFaltante`.`created_on` as date))) from `APC_LOAN_DETAIL` `ldFaltante` where ((`ldFaltante`.`id_loan` = `l`.`id`) and (week(cast(`ldFaltante`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldFaltante`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldFaltante`.`created_on` as date))) not in ('saturday','sunday')) and (`ldFaltante`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER','FEE'))))) - (select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (`ldLunes`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER'))))) AS `faltante`,(case when ((`l`.`new_customer` = 'ENEBLED') and (week(cast(`l`.`created_on` as date),1) = week(curdate(),1))) then 'Si' else 'No' end) AS `new_customer`,if(((select count(`lbr`.`id_loan_old`) from (`APC_LOAN_BY_RENOVATION` `lbr` join `APC_LOAN` `lRenovation` on((`lbr`.`id_loan_new` = `lRenovation`.`id`))) where ((`lbr`.`id_loan_old` = `l`.`id`) and (`lbr`.`loan_by_renovation_status` = 'APPROVED') and (week(cast(`lRenovation`.`created_on` as date),1) <= week(curdate(),1)) and (year(cast(`lRenovation`.`created_on` as date)) = year(curdate())))) = 0),'No','Si') AS `renovation`,`l`.`loan_status` AS `estatus_prestamo`,(select count(distinct cast(`ldFaltante`.`created_on` as date)) from `APC_LOAN_DETAIL` `ldFaltante` where ((`ldFaltante`.`id_loan` = `l`.`id`) and (week(cast(`ldFaltante`.`created_on` as date),1) <= week(curdate(),1)) and (year(cast(`ldFaltante`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldFaltante`.`created_on` as date))) not in ('saturday','sunday')) and (`ldFaltante`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER','FEE')))) AS `num_pagos_all`,(select if((count(distinct cast(`ldFaltante`.`created_on` as date)) > 5),5,count(distinct cast(`ldFaltante`.`created_on` as date))) from `APC_LOAN_DETAIL` `ldFaltante` where ((`ldFaltante`.`id_loan` = `l`.`id`) and (week(cast(`ldFaltante`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ldFaltante`.`created_on` as date)) = year(curdate())) and (lower(dayname(cast(`ldFaltante`.`created_on` as date))) not in ('saturday','sunday')) and (`ldFaltante`.`loan_details_type` in ('PAYMENT','RENOVATION_PAYMENT','TRANSFER','FEE')))) AS `num_pagos_week`,(select if((sum(`ldLunes`.`payment_amount`) is null),0,sum(`ldLunes`.`payment_amount`)) from `APC_LOAN_DETAIL` `ldLunes` where ((`ldLunes`.`id_loan` = `l`.`id`) and (week(cast(`ldLunes`.`created_on` as date),1) <= week(curdate(),1)) and (year(cast(`ldLunes`.`created_on` as date)) = year(curdate())) and (`ldLunes`.`loan_details_type` = 'FEE'))) AS `fee_todos` from (((((((`APC_LOAN` `l` join `APC_LOAN_TYPE` `lt` on((`l`.`id_loan_type` = `lt`.`id`))) join `APC_PEOPLE` `cus` on((`cus`.`id` = `l`.`id_customer`))) join `APC_PEOPLE` `endor` on((`endor`.`id` = `l`.`id_endorsement`))) join `APC_ROUTE` `r` on((`r`.`id` = `l`.`id_route`))) join `APC_LOAN_BY_USER` `lbu` on((`lbu`.`id_loan` = `l`.`id`))) join `APC_USER` `u` on((`u`.`id` = `lbu`.`id_user`))) join `APC_HUMAN_RESOURCE` `hr` on((`hr`.`id` = `u`.`id_human_resource`))) where ((`l`.`loan_status` not in ('DELETED','REJECTED')) and (((select count(`ld`.`id`) from `APC_LOAN_DETAIL` `ld` where ((week(cast(`ld`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ld`.`created_on` as date)) = year(curdate())) and (`ld`.`id_loan` = `l`.`id`))) > 0) or (((select count(`ld`.`id`) from `APC_LOAN_DETAIL` `ld` where ((week(cast(`ld`.`created_on` as date),1) = week(curdate(),1)) and (year(cast(`ld`.`created_on` as date)) = year(curdate())) and (`ld`.`id_loan` = `l`.`id`))) = 0) and (`l`.`loan_status` = 'APPROVED') and (week(cast(`l`.`created_on` as date),1) <= week(curdate(),1)))));

